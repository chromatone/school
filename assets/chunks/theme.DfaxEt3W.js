import{r as O,o as V,_ as z,u as _,a as E,c as C,b as w,t as T,w as U,v as P,d as H,e as Y,f as Q,g as X,h as B,i as Z,T as ee,j as te}from"./framework.BgEibAZV.js";function ne(e){return e?`/auth/login/${e}`:"/auth/login"}var $="/",se=(e,n)=>(e.endsWith($)&&(e=e.slice(0,-1)),n.startsWith($)||(n=$+n),e+n),N=(e,n,s)=>{let t=e.pathname===$?n:se(e.pathname,n),r=new globalThis.URL(t,e);if(s)for(let[l,a]of Object.entries(ge(s)))if(a&&typeof a=="object"&&!Array.isArray(a))for(let[d,c]of Object.entries(a))r.searchParams.set(`${l}[${d}]`,String(c));else r.searchParams.set(l,a);return r};function re(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function oe(e){var n;if(!(typeof e!="object"||!e)){if(re(e)){let s=(n=e.headers.get("Content-Type"))==null?void 0:n.toLowerCase();if(s!=null&&s.startsWith("application/json")||s!=null&&s.startsWith("application/health+json")){let t=await e.json();if(!e.ok||"errors"in t)throw t;return"data"in t?t.data:t}if(s!=null&&s.startsWith("text/html")||s!=null&&s.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e}if("errors"in e)throw e;return"data"in e?e.data:e}}var L=async(e,n,s=globalThis.fetch)=>(n.headers=typeof n.headers=="object"&&!Array.isArray(n.headers)?n.headers:{},s(e,n).then(t=>oe(t).catch(r=>{let l={errors:r&&typeof r=="object"&&"errors"in r?r.errors:r,response:t};return r&&typeof r=="object"&&"data"in r&&(l.data=r.data),Promise.reject(l)}))),ae=()=>{let e=null;return{get:async()=>e,set:async n=>{e=n}}},ie={msRefreshBeforeExpires:3e4,autoRefresh:!0},ce=2**31-1,le=(e="cookie",n={})=>s=>{let t={...ie,...n},r=null,l=null,a=t.storage??ae(),d=async()=>a.set({access_token:null,refresh_token:null,expires:null,expires_at:null}),c=async()=>{try{await r}finally{r=null}},p=async()=>{let u=await a.get();return r||!(u!=null&&u.expires_at)||u.expires_at<new Date().getTime()+t.msRefreshBeforeExpires&&R().catch(g=>{}),c()},A=async u=>{let g=u.expires??0;u.expires_at=new Date().getTime()+g,await a.set(u),t.autoRefresh&&g>t.msRefreshBeforeExpires&&g<ce&&(l&&clearTimeout(l),l=setTimeout(()=>{l=null,R().catch(m=>{})},g-t.msRefreshBeforeExpires))},R=async()=>(r=(async()=>{let u=await a.get();await d();let g={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(g.credentials=t.credentials);let m={mode:e};e==="json"&&(u!=null&&u.refresh_token)&&(m.refresh_token=u.refresh_token),g.body=JSON.stringify(m);let v=N(s.url,"/auth/refresh");return L(v.toString(),g,s.globals.fetch).then(o=>A(o).then(()=>o))})(),r);return{refresh:R,async login(u,g,m={}){await d();let v={email:u,password:g};"otp"in m&&(v.otp=m.otp),v.mode=m.mode??e;let o=ne(m.provider),i=N(s.url,o),f={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)};"credentials"in t&&(f.credentials=t.credentials);let h=await L(i.toString(),f,s.globals.fetch);return await A(h),h},async logout(){let u=await a.get(),g={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(g.credentials=t.credentials);let m={mode:e};e==="json"&&(u!=null&&u.refresh_token)&&(m.refresh_token=u.refresh_token),g.body=JSON.stringify(m);let v=N(s.url,"/auth/logout");await L(v.toString(),g,s.globals.fetch),this.stopRefreshing(),await d()},stopRefreshing(){l&&clearTimeout(l)},async getToken(){var u;return await p().catch(()=>{}),((u=await a.get())==null?void 0:u.access_token)??null},async setToken(u){return a.set({access_token:u,refresh_token:null,expires:null,expires_at:null})}}},Ue=e=>n=>{let s=e??null;return{async getToken(){return s},async setToken(t){s=t}}},I={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},ue=(e,n={})=>{let s=n.globals?{...I,...n.globals}:I;return{globals:s,url:new s.URL(e),with(t){return{...this,...t(this)}}}};function W(e){return JSON.stringify({...e,type:"auth"})}var de=()=>JSON.stringify({type:"pong"});function*G(){let e=1;for(;;)yield String(e),e++}var D=(e,n=1e3)=>new Promise((s,t)=>{let r=c=>{try{let p=JSON.parse(c.data);typeof p=="object"&&!Array.isArray(p)&&p!==null?(a(),s(p)):(a(),l())}catch{a(),s(c)}},l=()=>t(),a=()=>{clearTimeout(d),e.removeEventListener("message",r),e.removeEventListener("error",l),e.removeEventListener("close",l)};e.addEventListener("message",r),e.addEventListener("error",l),e.addEventListener("close",l);let d=setTimeout(()=>{a(),s(void 0)},n)}),fe={authMode:"handshake",heartbeat:!0,debug:!1,reconnect:{delay:1e3,retries:10}};function Pe(e={}){return n=>{e={...fe,...e};let s=G(),t={code:"closed"},r={attempts:0,active:!1},l=!1,a=new Set,d=o=>"getToken"in o,c=(o,...i)=>e.debug&&n.globals.logger[o]("[Directus SDK]",...i),p=async(o,i)=>{let f=new n.globals.URL(o);if(e.authMode==="strict"&&d(i)){let h=await i.getToken();h&&f.searchParams.set("access_token",h)}return f.toString()},A=async o=>{if("url"in e)return await p(e.url,o);if(["ws:","wss:"].includes(n.url.protocol))return await p(n.url,o);let i=new n.globals.URL(n.url.toString());return i.protocol=n.url.protocol==="https:"?"wss:":"ws:",i.pathname="/websocket",await p(i,o)},R=o=>{let i=new Promise((f,h)=>{if(!e.reconnect||l)return h();if(c("info",`reconnect #${r.attempts} `+(r.attempts>=e.reconnect.retries?"maximum retries reached":`trying again in ${Math.max(100,e.reconnect.delay)}ms`)),r.active)return r.active;if(r.attempts>=e.reconnect.retries)return r.attempts=-1,h();setTimeout(()=>o.connect().then(S=>(a.forEach(y=>{o.sendMessage(y)}),S)).then(f).catch(h),Math.max(100,e.reconnect.delay))});r.attempts+=1,r.active=i.catch(()=>{}).finally(()=>{r.active=!1})},u={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])};function g(o){return"type"in o&&"status"in o&&"error"in o&&"code"in o.error&&"message"in o.error&&o.type==="auth"&&o.status==="error"}async function m(o,i){if(t.code==="open"){if(o.error.code==="TOKEN_EXPIRED"&&(c("warn","Authentication token expired!"),d(i))){let f=await i.getToken();if(!f)throw Error("No token for re-authenticating the websocket");t.connection.send(W({access_token:f}))}if(o.error.code==="AUTH_TIMEOUT")return t.firstMessage&&e.authMode==="public"?(c("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1):c("warn","Authentication timed out!"),t.connection.close();if(o.error.code==="AUTH_FAILED"){if(t.firstMessage&&e.authMode==="public")return c("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1,t.connection.close();c("warn","Authentication failed!")}}}let v=async o=>{for(;t.code==="open";){let i=await D(t.connection).catch(()=>{});if(i){if(g(i)){await m(i,o),t.firstMessage=!1;continue}if(e.heartbeat&&i.type==="ping"){t.connection.send(de()),t.firstMessage=!1;continue}u.message.forEach(f=>{t.code==="open"&&f.call(t.connection,i)}),t.firstMessage=!1}}};return{async connect(){if(l=!1,t.code==="connecting")return await t.connection;if(t.code!=="closed")throw new Error(`Cannot connect when state is "${t.code}"`);let o=this,i=await A(o);c("info",`Connecting to ${i}...`);let f=new Promise((h,S)=>{let y=!1,b=new n.globals.WebSocket(i);b.addEventListener("open",async x=>{if(c("info","Connection open."),t={code:"open",connection:b,firstMessage:!0},r.attempts=0,r.active=!1,v(o),e.authMode==="handshake"&&d(o)){let k=await o.getToken();if(!k)throw Error("No token for authenticating the websocket. Make sure to provide one or call the login() function beforehand.");b.send(W({access_token:k}));let M=await D(b);if(M&&"type"in M&&"status"in M&&M.type==="auth"&&M.status==="ok")c("info","Authentication successful!");else return S("Authentication failed while opening websocket connection")}u.open.forEach(k=>k.call(b,x)),y=!0,h(b)}),b.addEventListener("error",x=>{c("warn","Connection errored."),u.error.forEach(k=>k.call(b,x)),b.close(),t={code:"error"},y||S(x)}),b.addEventListener("close",x=>{c("info","Connection closed."),u.close.forEach(k=>k.call(b,x)),s=G(),t={code:"closed"},R(this),y||S(x)})});return t={code:"connecting",connection:f},f},disconnect(){l=!0,t.code==="open"&&t.connection.close()},onWebSocket(o,i){if(o==="message"){let f=function(h){if(typeof h.data!="string")return i.call(this,h);try{return i.call(this,JSON.parse(h.data))}catch{return i.call(this,h)}};return u[o].add(f),()=>u[o].delete(f)}return u[o].add(i),()=>u[o].delete(i)},sendMessage(o){if(t.code!=="open")throw new Error('Cannot send messages without an open connection. Make sure you are calling "await client.connect()".');if(typeof o=="string")return t.connection.send(o);"uid"in o||(o.uid=s.next().value),t.connection.send(JSON.stringify(o))},async subscribe(o,i={}){"uid"in i||(i.uid=s.next().value),a.add({...i,collection:o,type:"subscribe"}),t.code!=="open"&&(c("info","No connection available for subscribing!"),await this.connect()),this.sendMessage({...i,collection:o,type:"subscribe"});let f=!0;async function*h(){for(;f&&t.code==="open";){let y=await D(t.connection).catch(()=>{});if(y){if("type"in y&&"status"in y&&y.type==="subscribe"&&y.status==="error")throw y;"type"in y&&"uid"in y&&y.type==="subscription"&&y.uid===i.uid&&(yield y)}}e.reconnect&&r.active&&(await r.active,t.code==="open"&&(t.connection.send(JSON.stringify({...i,collection:o,type:"subscribe"})),yield*h()))}let S=()=>{a.delete({...i,collection:o,type:"subscribe"}),this.sendMessage({uid:i.uid,type:"unsubscribe"}),f=!1};return{subscription:h(),unsubscribe:S}}}}}function he(e){return["directus_access","directus_activity","directus_collections","directus_comments","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var pe=e=>{let n=(s,t=[])=>{if(typeof s=="object"){let r=[];for(let l in s){let a=s[l]??[];if(Array.isArray(a))for(let d of a)r.push(n(d,[...t,l]));else if(typeof a=="object")for(let d of Object.keys(a)){let c=a[d];for(let p of c)r.push(n(p,[...t,`${l}:${d}`]))}}return r.flatMap(l=>l)}return[...t,String(s)].join(".")};return e.flatMap(s=>n(s))},ge=e=>{let n={};Array.isArray(e.fields)&&e.fields.length>0&&(n.fields=pe(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(n.filter=JSON.stringify(e.filter)),e.search&&(n.search=e.search),"sort"in e&&e.sort&&(n.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(n.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(n.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(n.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(n.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(n.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(n.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(n.groupBy=e.groupBy.join(","));for(let[s,t]of Object.entries(e))s in n||(typeof t=="string"||typeof t=="number"||typeof t=="boolean"?n[s]=String(t):n[s]=JSON.stringify(t));return n},J=(e,n)=>{if(e.length===0)throw new Error(n)},K=(e,n)=>{if(he(String(e)))throw new Error(n)},Ie=(e,n)=>()=>(J(String(e),"Collection cannot be empty"),K(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:n??{},method:"GET"}),We=(e,n,s)=>()=>(J(String(e),"Collection cannot be empty"),K(e,"Cannot use readItem for core collections"),J(String(n),"Key cannot be empty"),{path:`/items/${e}/${n}`,params:s??{},method:"GET"}),ye=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),Ge=(e,n,s)=>()=>(J(e,"Key cannot be empty"),{path:`/users/${e}`,params:s??{},body:JSON.stringify(n),method:"PATCH"}),we=(e,n,s={})=>()=>({path:"/users/register",method:"POST",body:JSON.stringify({email:e,password:n,...s})}),me={},be=(e={})=>n=>{let s={...me,...e};return{async request(t){let r=t();if(r.headers||(r.headers={}),"Content-Type"in r.headers?r.headers["Content-Type"]==="multipart/form-data"&&delete r.headers["Content-Type"]:r.headers["Content-Type"]="application/json","getToken"in this&&!("Authorization"in r.headers)){let c=await this.getToken();c&&(r.headers.Authorization=`Bearer ${c}`)}let l=N(n.url,r.path,r.params),a={method:r.method??"GET",headers:r.headers??{}};"credentials"in s&&(a.credentials=s.credentials),r.body&&(a.body=r.body),r.onRequest&&(a=await r.onRequest(a)),s.onRequest&&(a=await s.onRequest(a));let d=await L(l.toString(),a,n.globals.fetch);return"onResponse"in r&&(d=await r.onResponse(d,a)),"onResponse"in e&&(d=await e.onResponse(d,a)),d}}};const q=O(null),_e=O(!1),j=ue("https://schooldb.chromatone.center/").with(le("cookie",{credentials:"include",autoRefresh:!0})).with(be({credentials:"include"}));function F(){V(async()=>{j.refresh(),await j.getToken()&&n()});async function e(s,t,r){s?(await j.login(t,r),n()):(await j.request(we(t,r)),_e.value=!0)}async function n(){q.value=await j.request(ye())}return{user:q,userDB:j,auth:e}}const ve={key:0,class:"p-4"},ke={class:"flex gap-2 items-center p-2"},Se=["src"],xe={class:"flex flex-col"},Te={class:"text-2xl"},je={class:"text-xs op-50"},Ee={class:"text-2xl"},Ce={class:"p-2 border-2",type:"submit"},Oe={class:"flex gap-1"},Re={__name:"AuthForm",setup(e){const n=O(""),s=O(""),t=O(!0),{user:r,userDB:l,auth:a}=F();return(d,c)=>_(r)?(E(),C("div",ve,[w("div",ke,[w("img",{class:"rounded-full",src:`https://schooldb.chromatone.center/assets/${_(r).avatar}?width=50&height=50`},null,8,Se),w("div",xe,[w("div",Te,T(_(r).first_name)+" "+T(_(r).last_name),1),w("div",je,T(_(r).location),1)])])])):(E(),C("form",{key:1,class:"flex flex-col gap-4",onSubmit:c[3]||(c[3]=H(p=>_(a)(t.value,n.value,s.value),["prevent","stop"]))},[w("h2",Ee,T(t.value?"Sign In":"Sign Up"),1),U(w("input",{type:"email","onUpdate:modelValue":c[0]||(c[0]=p=>n.value=p),placeholder:"Your email"},null,512),[[P,n.value]]),U(w("input",{type:"password","onUpdate:modelValue":c[1]||(c[1]=p=>s.value=p),placeholder:"Your password"},null,512),[[P,s.value]]),w("button",Ce,T(t.value?"LOGIN":"REGISTER"),1),w("div",Oe,[c[4]||(c[4]=w("div",{class:"op-30"},"Don't have an account?",-1)),w("a",{class:"cursor-pointer underline",onClick:c[2]||(c[2]=p=>t.value=!t.value)},T(t.value?"Register":"Login"),1)])],32))}},Me=z(Re,[["__scopeId","data-v-ff4de240"]]),Ae={class:"flex flex-col p-4 w-full h-full justify-center relative"},$e={key:0,class:"op-50",href:"/"},Ne=["src"],Le={key:1,class:"i-la-user"},Je={class:"text-2xl"},Be={__name:"Layout",setup(e){const{frontmatter:n}=Y(),s=O(!1),{user:t}=F();return(r,l)=>{var d;const a=Q("content");return E(),C("div",Ae,[_(n).home?X("",!0):(E(),C("a",$e,"Creative Multimedia School")),w("button",{class:"op-50 fixed top-4 right-4 z-100 text-2xl p-2 rounded-full bg-dark-400",onClick:l[0]||(l[0]=c=>s.value=!s.value)},[(d=_(t))!=null&&d.avatar?(E(),C("img",{key:0,class:"rounded-full",src:`https://schooldb.chromatone.center/assets/${_(t).avatar}?width=40&height=40`},null,8,Ne)):(E(),C("div",Le))]),B(ee,{name:"fade"},{default:Z(()=>[U(B(Me,{class:"bg-dark-300 p-4 pt-8 pr-8 rounded-2xl shadow-xl fixed top-4 right-4 z-90"},null,512),[[te,s.value]])]),_:1}),w("h1",Je,T(_(n).title),1),B(a,{class:"prose"})])}}},qe={Layout:Be,enhanceApp({app:e,router:n,siteData:s}){}};export{Me as A,be as F,Ie as G,We as K,qe as R,Ge as _,ue as l,Ue as p,F as u,Pe as v};
