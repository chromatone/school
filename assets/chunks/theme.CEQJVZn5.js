import{r as M,o as z,_ as H,u as _,a as C,c as O,b as p,t as j,w as P,v as I,d as Y,e as Q,f as X,g as Z,h as U,i as ee,T as te,j as se}from"./framework.KJHvv_yO.js";function ne(e){return e?`/auth/login/${e}`:"/auth/login"}var $="/",re=(e,s)=>(e.endsWith($)&&(e=e.slice(0,-1)),s.startsWith($)||(s=$+s),e+s),N=(e,s,n)=>{let t=e.pathname===$?s:re(e.pathname,s),r=new globalThis.URL(t,e);if(n)for(let[i,a]of Object.entries(ge(n)))if(a&&typeof a=="object"&&!Array.isArray(a))for(let[u,f]of Object.entries(a))r.searchParams.set(`${i}[${u}]`,String(f));else r.searchParams.set(i,a);return r};function oe(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function ae(e){var s;if(!(typeof e!="object"||!e)){if(oe(e)){let n=(s=e.headers.get("Content-Type"))==null?void 0:s.toLowerCase();if(n!=null&&n.startsWith("application/json")||n!=null&&n.startsWith("application/health+json")){let t=await e.json();if(!e.ok||"errors"in t)throw t;return"data"in t?t.data:t}if(n!=null&&n.startsWith("text/html")||n!=null&&n.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e}if("errors"in e)throw e;return"data"in e?e.data:e}}var L=async(e,s,n=globalThis.fetch)=>(s.headers=typeof s.headers=="object"&&!Array.isArray(s.headers)?s.headers:{},n(e,s).then(t=>ae(t).catch(r=>{let i={errors:r&&typeof r=="object"&&"errors"in r?r.errors:r,response:t};return r&&typeof r=="object"&&"data"in r&&(i.data=r.data),Promise.reject(i)}))),ie=()=>{let e=null;return{get:async()=>e,set:async s=>{e=s}}},ce={msRefreshBeforeExpires:3e4,autoRefresh:!0},le=2**31-1,ue=(e="cookie",s={})=>n=>{let t={...ce,...s},r=null,i=null,a=t.storage??ie(),u=async()=>a.set({access_token:null,refresh_token:null,expires:null,expires_at:null}),f=async()=>{try{await r}finally{r=null}},d=async()=>{let l=await a.get();return r||!(l!=null&&l.expires_at)||l.expires_at<new Date().getTime()+t.msRefreshBeforeExpires&&R().catch(y=>{}),f()},b=async l=>{let y=l.expires??0;l.expires_at=new Date().getTime()+y,await a.set(l),t.autoRefresh&&y>t.msRefreshBeforeExpires&&y<le&&(i&&clearTimeout(i),i=setTimeout(()=>{i=null,R().catch(w=>{})},y-t.msRefreshBeforeExpires))},R=async()=>(r=(async()=>{let l=await a.get();await u();let y={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(y.credentials=t.credentials);let w={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(w.refresh_token=l.refresh_token),y.body=JSON.stringify(w);let k=N(n.url,"/auth/refresh");return L(k.toString(),y,n.globals.fetch).then(o=>b(o).then(()=>o))})(),r);return{refresh:R,async login(l,y,w={}){await u();let k={email:l,password:y};"otp"in w&&(k.otp=w.otp),k.mode=w.mode??e;let o=ne(w.provider),c=N(n.url,o),h={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)};"credentials"in t&&(h.credentials=t.credentials);let g=await L(c.toString(),h,n.globals.fetch);return await b(g),g},async logout(){let l=await a.get(),y={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(y.credentials=t.credentials);let w={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(w.refresh_token=l.refresh_token),y.body=JSON.stringify(w);let k=N(n.url,"/auth/logout");await L(k.toString(),y,n.globals.fetch),this.stopRefreshing(),await u()},stopRefreshing(){i&&clearTimeout(i)},async getToken(){var l;return await d().catch(()=>{}),((l=await a.get())==null?void 0:l.access_token)??null},async setToken(l){return a.set({access_token:l,refresh_token:null,expires:null,expires_at:null})}}},Pe=e=>s=>{let n=e??null;return{async getToken(){return n},async setToken(t){n=t}}},W={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},de=(e,s={})=>{let n=s.globals?{...W,...s.globals}:W;return{globals:n,url:new n.URL(e),with(t){return{...this,...t(this)}}}};function G(e){return JSON.stringify({...e,type:"auth"})}var fe=()=>JSON.stringify({type:"pong"});function*q(){let e=1;for(;;)yield String(e),e++}var B=(e,s=1e3)=>new Promise((n,t)=>{let r=f=>{try{let d=JSON.parse(f.data);typeof d=="object"&&!Array.isArray(d)&&d!==null?(a(),n(d)):(a(),i())}catch{a(),n(f)}},i=()=>t(),a=()=>{clearTimeout(u),e.removeEventListener("message",r),e.removeEventListener("error",i),e.removeEventListener("close",i)};e.addEventListener("message",r),e.addEventListener("error",i),e.addEventListener("close",i);let u=setTimeout(()=>{a(),n(void 0)},s)}),he={authMode:"handshake",heartbeat:!0,debug:!1,reconnect:{delay:1e3,retries:10}};function Ie(e={}){return s=>{e={...he,...e};let n=q(),t={code:"closed"},r={attempts:0,active:!1},i=!1,a=new Set,u=o=>"getToken"in o,f=(o,...c)=>e.debug&&s.globals.logger[o]("[Directus SDK]",...c),d=async(o,c)=>{let h=new s.globals.URL(o);if(e.authMode==="strict"&&u(c)){let g=await c.getToken();g&&h.searchParams.set("access_token",g)}return h.toString()},b=async o=>{if("url"in e)return await d(e.url,o);if(["ws:","wss:"].includes(s.url.protocol))return await d(s.url,o);let c=new s.globals.URL(s.url.toString());return c.protocol=s.url.protocol==="https:"?"wss:":"ws:",c.pathname="/websocket",await d(c,o)},R=o=>{let c=new Promise((h,g)=>{if(!e.reconnect||i)return g();if(f("info",`reconnect #${r.attempts} `+(r.attempts>=e.reconnect.retries?"maximum retries reached":`trying again in ${Math.max(100,e.reconnect.delay)}ms`)),r.active)return r.active;if(r.attempts>=e.reconnect.retries)return r.attempts=-1,g();setTimeout(()=>o.connect().then(S=>(a.forEach(m=>{o.sendMessage(m)}),S)).then(h).catch(g),Math.max(100,e.reconnect.delay))});r.attempts+=1,r.active=c.catch(()=>{}).finally(()=>{r.active=!1})},l={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])};function y(o){return"type"in o&&"status"in o&&"error"in o&&"code"in o.error&&"message"in o.error&&o.type==="auth"&&o.status==="error"}async function w(o,c){if(t.code==="open"){if(o.error.code==="TOKEN_EXPIRED"&&(f("warn","Authentication token expired!"),u(c))){let h=await c.getToken();if(!h)throw Error("No token for re-authenticating the websocket");t.connection.send(G({access_token:h}))}if(o.error.code==="AUTH_TIMEOUT")return t.firstMessage&&e.authMode==="public"?(f("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1):f("warn","Authentication timed out!"),t.connection.close();if(o.error.code==="AUTH_FAILED"){if(t.firstMessage&&e.authMode==="public")return f("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1,t.connection.close();f("warn","Authentication failed!")}}}let k=async o=>{for(;t.code==="open";){let c=await B(t.connection).catch(()=>{});if(c){if(y(c)){await w(c,o),t.firstMessage=!1;continue}if(e.heartbeat&&c.type==="ping"){t.connection.send(fe()),t.firstMessage=!1;continue}l.message.forEach(h=>{t.code==="open"&&h.call(t.connection,c)}),t.firstMessage=!1}}};return{async connect(){if(i=!1,t.code==="connecting")return await t.connection;if(t.code!=="closed")throw new Error(`Cannot connect when state is "${t.code}"`);let o=this,c=await b(o);f("info",`Connecting to ${c}...`);let h=new Promise((g,S)=>{let m=!1,v=new s.globals.WebSocket(c);v.addEventListener("open",async T=>{if(f("info","Connection open."),t={code:"open",connection:v,firstMessage:!0},r.attempts=0,r.active=!1,k(o),e.authMode==="handshake"&&u(o)){let x=await o.getToken();if(!x)throw Error("No token for authenticating the websocket. Make sure to provide one or call the login() function beforehand.");v.send(G({access_token:x}));let A=await B(v);if(A&&"type"in A&&"status"in A&&A.type==="auth"&&A.status==="ok")f("info","Authentication successful!");else return S("Authentication failed while opening websocket connection")}l.open.forEach(x=>x.call(v,T)),m=!0,g(v)}),v.addEventListener("error",T=>{f("warn","Connection errored."),l.error.forEach(x=>x.call(v,T)),v.close(),t={code:"error"},m||S(T)}),v.addEventListener("close",T=>{f("info","Connection closed."),l.close.forEach(x=>x.call(v,T)),n=q(),t={code:"closed"},R(this),m||S(T)})});return t={code:"connecting",connection:h},h},disconnect(){i=!0,t.code==="open"&&t.connection.close()},onWebSocket(o,c){if(o==="message"){let h=function(g){if(typeof g.data!="string")return c.call(this,g);try{return c.call(this,JSON.parse(g.data))}catch{return c.call(this,g)}};return l[o].add(h),()=>l[o].delete(h)}return l[o].add(c),()=>l[o].delete(c)},sendMessage(o){if(t.code!=="open")throw new Error('Cannot send messages without an open connection. Make sure you are calling "await client.connect()".');if(typeof o=="string")return t.connection.send(o);"uid"in o||(o.uid=n.next().value),t.connection.send(JSON.stringify(o))},async subscribe(o,c={}){"uid"in c||(c.uid=n.next().value),a.add({...c,collection:o,type:"subscribe"}),t.code!=="open"&&(f("info","No connection available for subscribing!"),await this.connect()),this.sendMessage({...c,collection:o,type:"subscribe"});let h=!0;async function*g(){for(;h&&t.code==="open";){let m=await B(t.connection).catch(()=>{});if(m){if("type"in m&&"status"in m&&m.type==="subscribe"&&m.status==="error")throw m;"type"in m&&"uid"in m&&m.type==="subscription"&&m.uid===c.uid&&(yield m)}}e.reconnect&&r.active&&(await r.active,t.code==="open"&&(t.connection.send(JSON.stringify({...c,collection:o,type:"subscribe"})),yield*g()))}let S=()=>{a.delete({...c,collection:o,type:"subscribe"}),this.sendMessage({uid:c.uid,type:"unsubscribe"}),h=!1};return{subscription:g(),unsubscribe:S}}}}}function K(e){return["directus_access","directus_activity","directus_collections","directus_comments","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var We=(e,s,n)=>()=>{let t=String(e);if(K(t))throw new Error("Cannot use createItem for core collections");return{path:`/items/${t}`,params:n??{},body:JSON.stringify(s),method:"POST"}},pe=e=>{let s=(n,t=[])=>{if(typeof n=="object"){let r=[];for(let i in n){let a=n[i]??[];if(Array.isArray(a))for(let u of a)r.push(s(u,[...t,i]));else if(typeof a=="object")for(let u of Object.keys(a)){let f=a[u];for(let d of f)r.push(s(d,[...t,`${i}:${u}`]))}}return r.flatMap(i=>i)}return[...t,String(n)].join(".")};return e.flatMap(n=>s(n))},ge=e=>{let s={};Array.isArray(e.fields)&&e.fields.length>0&&(s.fields=pe(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(s.filter=JSON.stringify(e.filter)),e.search&&(s.search=e.search),"sort"in e&&e.sort&&(s.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(s.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(s.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(s.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(s.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(s.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(s.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(s.groupBy=e.groupBy.join(","));for(let[n,t]of Object.entries(e))n in s||(typeof t=="string"||typeof t=="number"||typeof t=="boolean"?s[n]=String(t):s[n]=JSON.stringify(t));return s},J=(e,s)=>{if(e.length===0)throw new Error(s)},F=(e,s)=>{if(K(String(e)))throw new Error(s)},Ge=(e,s)=>()=>(J(String(e),"Collection cannot be empty"),F(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:s??{},method:"GET"}),qe=(e,s,n)=>()=>(J(String(e),"Collection cannot be empty"),F(e,"Cannot use readItem for core collections"),J(String(s),"Key cannot be empty"),{path:`/items/${e}/${s}`,params:n??{},method:"GET"}),ye=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),Ke=(e,s,n)=>()=>(J(e,"Key cannot be empty"),{path:`/users/${e}`,params:n??{},body:JSON.stringify(s),method:"PATCH"}),me=(e,s,n={})=>()=>({path:"/users/register",method:"POST",body:JSON.stringify({email:e,password:s,...n})}),we={},be=(e={})=>s=>{let n={...we,...e};return{async request(t){let r=t();if(r.headers||(r.headers={}),"Content-Type"in r.headers?r.headers["Content-Type"]==="multipart/form-data"&&delete r.headers["Content-Type"]:r.headers["Content-Type"]="application/json","getToken"in this&&!("Authorization"in r.headers)){let f=await this.getToken();f&&(r.headers.Authorization=`Bearer ${f}`)}let i=N(s.url,r.path,r.params),a={method:r.method??"GET",headers:r.headers??{}};"credentials"in n&&(a.credentials=n.credentials),r.body&&(a.body=r.body),r.onRequest&&(a=await r.onRequest(a)),n.onRequest&&(a=await n.onRequest(a));let u=await L(i.toString(),a,s.globals.fetch);return"onResponse"in r&&(u=await r.onResponse(u,a)),"onResponse"in e&&(u=await e.onResponse(u,a)),u}}};const D=M(null),ve=M(!1),E=de("https://schooldb.chromatone.center/").with(ue("cookie",{credentials:"include",autoRefresh:!0})).with(be({credentials:"include"}));function V(){z(async()=>{E.refresh(),await E.getToken()&&s()});async function e(t,r,i){t?(await E.login(r,i),s()):(await E.request(me(r,i)),ve.value=!0)}async function s(){D.value=await E.request(ye())}async function n(){await E.logout(),D.value=null}return{user:D,userDB:E,auth:e,logout:n}}const _e={key:0,class:"p-4 flex flex-col gap-2"},ke={class:"flex gap-2 items-center p-2"},xe=["src"],Se={class:"flex flex-col"},Te={class:"text-2xl"},Ee={class:"text-xs op-50"},je={class:"flex flex-wrap gap-2"},Ce={class:"text-2xl"},Oe={class:"p-2 border-2",type:"submit"},Me={class:"flex gap-1"},Re={__name:"AuthForm",setup(e){const s=M(""),n=M(""),t=M(!0),{user:r,userDB:i,auth:a,logout:u}=V();return(f,d)=>_(r)?(C(),O("div",_e,[p("div",ke,[p("img",{class:"rounded-full",src:`https://schooldb.chromatone.center/assets/${_(r).avatar}?width=50&height=50`},null,8,xe),p("div",Se,[p("div",Te,j(_(r).first_name)+" "+j(_(r).last_name),1),p("div",Ee,j(_(r).location),1)])]),p("div",je,[d[5]||(d[5]=p("a",{class:"no-underline p-2 bg-light-500 rounded-lg hover-bg-light-100",href:"/student"},"My page",-1)),p("button",{class:"p-2 bg-light-500 rounded-lg hover-bg-light-100",onClick:d[0]||(d[0]=b=>_(u)())},"Logout")])])):(C(),O("form",{key:1,class:"flex flex-col gap-4",onSubmit:d[4]||(d[4]=Y(b=>_(a)(t.value,s.value,n.value),["prevent","stop"]))},[p("h2",Ce,j(t.value?"Sign In":"Sign Up"),1),P(p("input",{type:"email","onUpdate:modelValue":d[1]||(d[1]=b=>s.value=b),placeholder:"Your email"},null,512),[[I,s.value]]),P(p("input",{type:"password","onUpdate:modelValue":d[2]||(d[2]=b=>n.value=b),placeholder:"Your password"},null,512),[[I,n.value]]),p("button",Oe,j(t.value?"LOGIN":"REGISTER"),1),p("div",Me,[d[6]||(d[6]=p("div",{class:"op-30"},"Don't have an account?",-1)),p("a",{class:"cursor-pointer underline",onClick:d[3]||(d[3]=b=>t.value=!t.value)},j(t.value?"Register":"Login"),1)])],32))}},Ae=H(Re,[["__scopeId","data-v-1fef907c"]]),$e={class:"flex flex-col items-start p-4 w-full h-full justify-stretch relative"},Ne={key:0,class:"op-50",href:"/"},Le=["src"],Je={key:1,class:"i-la-user"},Ue={class:"text-2xl"},Be={__name:"Layout",setup(e){const{frontmatter:s}=Q(),n=M(!1),{user:t}=V();return(r,i)=>{var u;const a=X("content");return C(),O("div",$e,[_(s).home?Z("",!0):(C(),O("a",Ne,"Creative Multimedia School")),p("button",{class:"op-50 fixed top-4 right-4 z-100 text-2xl p-2 rounded-full bg-light-400",onClick:i[0]||(i[0]=f=>n.value=!n.value)},[(u=_(t))!=null&&u.avatar?(C(),O("img",{key:0,class:"rounded-full",src:`https://schooldb.chromatone.center/assets/${_(t).avatar}?width=40&height=40`},null,8,Le)):(C(),O("div",Je))]),U(te,{name:"fade"},{default:ee(()=>[P(U(Ae,{class:"bg-light-300 p-4 pt-8 pr-8 rounded-2xl shadow-xl fixed top-4 right-4 z-90"},null,512),[[se,n.value]])]),_:1}),p("h1",Ue,j(_(s).title),1),U(a,{class:"prose max-w-unset flex-1"}),i[1]||(i[1]=p("div",{class:"flex flex-wrap gap-2 text-2xl w-full"},[p("a",{href:"/courses/"},"Courses"),p("a",{class:"flex-1",href:"/payments/"},"Payments"),p("a",{href:"/classes/"},"Classes")],-1))])}}},Fe={Layout:Be,enhanceApp({app:e,router:s,siteData:n}){}};export{Ae as A,be as F,Ge as G,qe as K,Fe as R,We as U,Ke as _,de as l,Pe as p,V as u,Ie as v};
