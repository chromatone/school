import{r as j,o as V,_ as z,u as k,a as $,c as L,b as m,t as x,w as B,v as D,d as H,e as Y,f as Q,g as X,h as Z,i as P}from"./framework.B8YXKKAO.js";function ee(e){return e?`/auth/login/${e}`:"/auth/login"}var M="/",te=(e,n)=>(e.endsWith(M)&&(e=e.slice(0,-1)),n.startsWith(M)||(n=M+n),e+n),A=(e,n,s)=>{let t=e.pathname===M?n:te(e.pathname,n),r=new globalThis.URL(t,e);if(s)for(let[u,a]of Object.entries(fe(s)))if(a&&typeof a=="object"&&!Array.isArray(a))for(let[d,c]of Object.entries(a))r.searchParams.set(`${u}[${d}]`,String(c));else r.searchParams.set(u,a);return r};function ne(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function se(e){var n;if(!(typeof e!="object"||!e)){if(ne(e)){let s=(n=e.headers.get("Content-Type"))==null?void 0:n.toLowerCase();if(s!=null&&s.startsWith("application/json")||s!=null&&s.startsWith("application/health+json")){let t=await e.json();if(!e.ok||"errors"in t)throw t;return"data"in t?t.data:t}if(s!=null&&s.startsWith("text/html")||s!=null&&s.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e}if("errors"in e)throw e;return"data"in e?e.data:e}}var N=async(e,n,s=globalThis.fetch)=>(n.headers=typeof n.headers=="object"&&!Array.isArray(n.headers)?n.headers:{},s(e,n).then(t=>se(t).catch(r=>{let u={errors:r&&typeof r=="object"&&"errors"in r?r.errors:r,response:t};return r&&typeof r=="object"&&"data"in r&&(u.data=r.data),Promise.reject(u)}))),re=()=>{let e=null;return{get:async()=>e,set:async n=>{e=n}}},oe={msRefreshBeforeExpires:3e4,autoRefresh:!0},ae=2**31-1,ie=(e="cookie",n={})=>s=>{let t={...oe,...n},r=null,u=null,a=t.storage??re(),d=async()=>a.set({access_token:null,refresh_token:null,expires:null,expires_at:null}),c=async()=>{try{await r}finally{r=null}},p=async()=>{let l=await a.get();return r||!(l!=null&&l.expires_at)||l.expires_at<new Date().getTime()+t.msRefreshBeforeExpires&&C().catch(g=>{}),c()},R=async l=>{let g=l.expires??0;l.expires_at=new Date().getTime()+g,await a.set(l),t.autoRefresh&&g>t.msRefreshBeforeExpires&&g<ae&&(u&&clearTimeout(u),u=setTimeout(()=>{u=null,C().catch(w=>{})},g-t.msRefreshBeforeExpires))},C=async()=>(r=(async()=>{let l=await a.get();await d();let g={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(g.credentials=t.credentials);let w={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(w.refresh_token=l.refresh_token),g.body=JSON.stringify(w);let v=A(s.url,"/auth/refresh");return N(v.toString(),g,s.globals.fetch).then(o=>R(o).then(()=>o))})(),r);return{refresh:C,async login(l,g,w={}){await d();let v={email:l,password:g};"otp"in w&&(v.otp=w.otp),v.mode=w.mode??e;let o=ee(w.provider),i=A(s.url,o),f={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)};"credentials"in t&&(f.credentials=t.credentials);let h=await N(i.toString(),f,s.globals.fetch);return await R(h),h},async logout(){let l=await a.get(),g={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(g.credentials=t.credentials);let w={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(w.refresh_token=l.refresh_token),g.body=JSON.stringify(w);let v=A(s.url,"/auth/logout");await N(v.toString(),g,s.globals.fetch),this.stopRefreshing(),await d()},stopRefreshing(){u&&clearTimeout(u)},async getToken(){var l;return await p().catch(()=>{}),((l=await a.get())==null?void 0:l.access_token)??null},async setToken(l){return a.set({access_token:l,refresh_token:null,expires:null,expires_at:null})}}},Le=e=>n=>{let s=e??null;return{async getToken(){return s},async setToken(t){s=t}}},I={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},ce=(e,n={})=>{let s=n.globals?{...I,...n.globals}:I;return{globals:s,url:new s.URL(e),with(t){return{...this,...t(this)}}}};function W(e){return JSON.stringify({...e,type:"auth"})}var le=()=>JSON.stringify({type:"pong"});function*G(){let e=1;for(;;)yield String(e),e++}var U=(e,n=1e3)=>new Promise((s,t)=>{let r=c=>{try{let p=JSON.parse(c.data);typeof p=="object"&&!Array.isArray(p)&&p!==null?(a(),s(p)):(a(),u())}catch{a(),s(c)}},u=()=>t(),a=()=>{clearTimeout(d),e.removeEventListener("message",r),e.removeEventListener("error",u),e.removeEventListener("close",u)};e.addEventListener("message",r),e.addEventListener("error",u),e.addEventListener("close",u);let d=setTimeout(()=>{a(),s(void 0)},n)}),ue={authMode:"handshake",heartbeat:!0,debug:!1,reconnect:{delay:1e3,retries:10}};function Je(e={}){return n=>{e={...ue,...e};let s=G(),t={code:"closed"},r={attempts:0,active:!1},u=!1,a=new Set,d=o=>"getToken"in o,c=(o,...i)=>e.debug&&n.globals.logger[o]("[Directus SDK]",...i),p=async(o,i)=>{let f=new n.globals.URL(o);if(e.authMode==="strict"&&d(i)){let h=await i.getToken();h&&f.searchParams.set("access_token",h)}return f.toString()},R=async o=>{if("url"in e)return await p(e.url,o);if(["ws:","wss:"].includes(n.url.protocol))return await p(n.url,o);let i=new n.globals.URL(n.url.toString());return i.protocol=n.url.protocol==="https:"?"wss:":"ws:",i.pathname="/websocket",await p(i,o)},C=o=>{let i=new Promise((f,h)=>{if(!e.reconnect||u)return h();if(c("info",`reconnect #${r.attempts} `+(r.attempts>=e.reconnect.retries?"maximum retries reached":`trying again in ${Math.max(100,e.reconnect.delay)}ms`)),r.active)return r.active;if(r.attempts>=e.reconnect.retries)return r.attempts=-1,h();setTimeout(()=>o.connect().then(S=>(a.forEach(y=>{o.sendMessage(y)}),S)).then(f).catch(h),Math.max(100,e.reconnect.delay))});r.attempts+=1,r.active=i.catch(()=>{}).finally(()=>{r.active=!1})},l={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])};function g(o){return"type"in o&&"status"in o&&"error"in o&&"code"in o.error&&"message"in o.error&&o.type==="auth"&&o.status==="error"}async function w(o,i){if(t.code==="open"){if(o.error.code==="TOKEN_EXPIRED"&&(c("warn","Authentication token expired!"),d(i))){let f=await i.getToken();if(!f)throw Error("No token for re-authenticating the websocket");t.connection.send(W({access_token:f}))}if(o.error.code==="AUTH_TIMEOUT")return t.firstMessage&&e.authMode==="public"?(c("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1):c("warn","Authentication timed out!"),t.connection.close();if(o.error.code==="AUTH_FAILED"){if(t.firstMessage&&e.authMode==="public")return c("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1,t.connection.close();c("warn","Authentication failed!")}}}let v=async o=>{for(;t.code==="open";){let i=await U(t.connection).catch(()=>{});if(i){if(g(i)){await w(i,o),t.firstMessage=!1;continue}if(e.heartbeat&&i.type==="ping"){t.connection.send(le()),t.firstMessage=!1;continue}l.message.forEach(f=>{t.code==="open"&&f.call(t.connection,i)}),t.firstMessage=!1}}};return{async connect(){if(u=!1,t.code==="connecting")return await t.connection;if(t.code!=="closed")throw new Error(`Cannot connect when state is "${t.code}"`);let o=this,i=await R(o);c("info",`Connecting to ${i}...`);let f=new Promise((h,S)=>{let y=!1,b=new n.globals.WebSocket(i);b.addEventListener("open",async T=>{if(c("info","Connection open."),t={code:"open",connection:b,firstMessage:!0},r.attempts=0,r.active=!1,v(o),e.authMode==="handshake"&&d(o)){let _=await o.getToken();if(!_)throw Error("No token for authenticating the websocket. Make sure to provide one or call the login() function beforehand.");b.send(W({access_token:_}));let O=await U(b);if(O&&"type"in O&&"status"in O&&O.type==="auth"&&O.status==="ok")c("info","Authentication successful!");else return S("Authentication failed while opening websocket connection")}l.open.forEach(_=>_.call(b,T)),y=!0,h(b)}),b.addEventListener("error",T=>{c("warn","Connection errored."),l.error.forEach(_=>_.call(b,T)),b.close(),t={code:"error"},y||S(T)}),b.addEventListener("close",T=>{c("info","Connection closed."),l.close.forEach(_=>_.call(b,T)),s=G(),t={code:"closed"},C(this),y||S(T)})});return t={code:"connecting",connection:f},f},disconnect(){u=!0,t.code==="open"&&t.connection.close()},onWebSocket(o,i){if(o==="message"){let f=function(h){if(typeof h.data!="string")return i.call(this,h);try{return i.call(this,JSON.parse(h.data))}catch{return i.call(this,h)}};return l[o].add(f),()=>l[o].delete(f)}return l[o].add(i),()=>l[o].delete(i)},sendMessage(o){if(t.code!=="open")throw new Error('Cannot send messages without an open connection. Make sure you are calling "await client.connect()".');if(typeof o=="string")return t.connection.send(o);"uid"in o||(o.uid=s.next().value),t.connection.send(JSON.stringify(o))},async subscribe(o,i={}){"uid"in i||(i.uid=s.next().value),a.add({...i,collection:o,type:"subscribe"}),t.code!=="open"&&(c("info","No connection available for subscribing!"),await this.connect()),this.sendMessage({...i,collection:o,type:"subscribe"});let f=!0;async function*h(){for(;f&&t.code==="open";){let y=await U(t.connection).catch(()=>{});if(y){if("type"in y&&"status"in y&&y.type==="subscribe"&&y.status==="error")throw y;"type"in y&&"uid"in y&&y.type==="subscription"&&y.uid===i.uid&&(yield y)}}e.reconnect&&r.active&&(await r.active,t.code==="open"&&(t.connection.send(JSON.stringify({...i,collection:o,type:"subscribe"})),yield*h()))}let S=()=>{a.delete({...i,collection:o,type:"subscribe"}),this.sendMessage({uid:i.uid,type:"unsubscribe"}),f=!1};return{subscription:h(),unsubscribe:S}}}}}function K(e){return["directus_access","directus_activity","directus_collections","directus_comments","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var Ue=(e,n,s)=>()=>{let t=String(e);if(K(t))throw new Error("Cannot use createItem for core collections");return{path:`/items/${t}`,params:s??{},body:JSON.stringify(n),method:"POST"}},de=e=>{let n=(s,t=[])=>{if(typeof s=="object"){let r=[];for(let u in s){let a=s[u]??[];if(Array.isArray(a))for(let d of a)r.push(n(d,[...t,u]));else if(typeof a=="object")for(let d of Object.keys(a)){let c=a[d];for(let p of c)r.push(n(p,[...t,`${u}:${d}`]))}}return r.flatMap(u=>u)}return[...t,String(s)].join(".")};return e.flatMap(s=>n(s))},fe=e=>{let n={};Array.isArray(e.fields)&&e.fields.length>0&&(n.fields=de(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(n.filter=JSON.stringify(e.filter)),e.search&&(n.search=e.search),"sort"in e&&e.sort&&(n.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(n.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(n.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(n.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(n.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(n.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(n.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(n.groupBy=e.groupBy.join(","));for(let[s,t]of Object.entries(e))s in n||(typeof t=="string"||typeof t=="number"||typeof t=="boolean"?n[s]=String(t):n[s]=JSON.stringify(t));return n},J=(e,n)=>{if(e.length===0)throw new Error(n)},F=(e,n)=>{if(K(String(e)))throw new Error(n)},Be=(e,n)=>()=>(J(String(e),"Collection cannot be empty"),F(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:n??{},method:"GET"}),De=(e,n,s)=>()=>(J(String(e),"Collection cannot be empty"),F(e,"Cannot use readItem for core collections"),J(String(n),"Key cannot be empty"),{path:`/items/${e}/${n}`,params:s??{},method:"GET"}),he=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),Pe=(e,n,s)=>()=>(J(e,"Key cannot be empty"),{path:`/users/${e}`,params:s??{},body:JSON.stringify(n),method:"PATCH"}),pe=(e,n,s={})=>()=>({path:"/users/register",method:"POST",body:JSON.stringify({email:e,password:n,...s})}),ge={},ye=(e={})=>n=>{let s={...ge,...e};return{async request(t){let r=t();if(r.headers||(r.headers={}),"Content-Type"in r.headers?r.headers["Content-Type"]==="multipart/form-data"&&delete r.headers["Content-Type"]:r.headers["Content-Type"]="application/json","getToken"in this&&!("Authorization"in r.headers)){let c=await this.getToken();c&&(r.headers.Authorization=`Bearer ${c}`)}let u=A(n.url,r.path,r.params),a={method:r.method??"GET",headers:r.headers??{}};"credentials"in s&&(a.credentials=s.credentials),r.body&&(a.body=r.body),r.onRequest&&(a=await r.onRequest(a)),s.onRequest&&(a=await s.onRequest(a));let d=await N(u.toString(),a,n.globals.fetch);return"onResponse"in r&&(d=await r.onResponse(d,a)),"onResponse"in e&&(d=await e.onResponse(d,a)),d}}};const q=j(null),me=j(!1),E=ce("https://schooldb.chromatone.center/").with(ie("cookie",{credentials:"include",autoRefresh:!0})).with(ye({credentials:"include"}));function we(){V(async()=>{E.refresh(),await E.getToken()&&n()});async function e(s,t,r){s?(await E.login(t,r),n()):(await E.request(pe(t,r)),me.value=!0)}async function n(){q.value=await E.request(he())}return{user:q,userDB:E,auth:e}}const be={key:0,class:"p-4"},ve={class:"flex gap-2 items-center p-2"},_e=["src"],ke={class:"flex flex-col"},Se={class:"text-2xl"},Te={class:"text-xs op-50"},xe={class:"text-2xl"},Ee={class:"p-2 border-2",type:"submit"},je={class:"flex gap-1"},Ce={__name:"AuthForm",setup(e){const n=j(""),s=j(""),t=j(!1),{user:r,userDB:u,auth:a}=we();return(d,c)=>k(r)?($(),L("div",be,[m("div",ve,[m("img",{class:"rounded-full",src:`https://schooldb.chromatone.center/assets/${k(r).avatar}?width=50&height=50`},null,8,_e),m("div",ke,[m("div",Se,x(k(r).first_name)+" "+x(k(r).last_name),1),m("div",Te,x(k(r).location),1)])])])):($(),L("form",{key:1,class:"flex flex-col gap-4",onSubmit:c[3]||(c[3]=H(p=>k(a)(t.value,n.value,s.value),["prevent","stop"]))},[m("h2",xe,x(t.value?"Sign In":"Sign Up"),1),B(m("input",{type:"email","onUpdate:modelValue":c[0]||(c[0]=p=>n.value=p),placeholder:"Your email"},null,512),[[D,n.value]]),B(m("input",{type:"password","onUpdate:modelValue":c[1]||(c[1]=p=>s.value=p),placeholder:"Your password"},null,512),[[D,s.value]]),m("button",Ee,x(t.value?"LOGIN":"REGISTER"),1),m("div",je,[c[4]||(c[4]=m("div",{class:"op-30"},"Don't have an account?",-1)),m("a",{class:"cursor-pointer underline",onClick:c[2]||(c[2]=p=>t.value=!t.value)},x(t.value?"Register":"Login"),1)])],32))}},Oe=z(Ce,[["__scopeId","data-v-52091c04"]]),Re={class:"flex flex-col p-4 w-full items-center h-full justify-center relative"},Me={key:0,class:"op-50",href:"/"},Ae={class:"text-4xl"},Ne={__name:"Layout",setup(e){const{frontmatter:n}=Y(),s=j(!1);return(t,r)=>{const u=Q("content");return $(),L("div",Re,[k(n).home?X("",!0):($(),L("a",Me,"Creative Multimedia School")),m("button",{class:"op-50 absolute top-4 right-4 z-100 text-2xl p-2 rounded-full bg-dark-400",onClick:r[0]||(r[0]=a=>s.value=!s.value)},r[1]||(r[1]=[m("div",{class:"i-la-user"},null,-1)])),B(P(Oe,{class:"bg-dark-300 p-4 rounded-xl shadow-xl absolute top-4 right-4 z-90"},null,512),[[Z,s.value]]),m("h1",Ae,x(k(n).title),1),P(u,{class:"prose"})])}}},Ie={Layout:Ne,enhanceApp({app:e,router:n,siteData:s}){}};export{Oe as A,ye as F,Be as G,De as K,Ie as R,Ue as U,Pe as _,ce as l,Le as p,we as u,Je as v};
